{{define "main"}}
<script>
  const es = new EventSource("/es/room-{{.RoomID}}");

  // dispatch event to <body> for use by hx-trigger
  es.addEventListener("NEW_MESSAGE", (e) => {
    document.getElementsByTagName('body')[0].dispatchEvent(new Event("NEW_MESSAGE"))
  })
</script>

<div class="f-col height:100%">
  <div class="f-col height:100%">
    <h1>Chat with {{.User.Username}}</h1>

    <div class="flex-grow:1 overflow:auto height:100%">
      <div class="scroller height:100%" style="display: flex; flex-direction: column-reverse; overflow: auto">
        <div id="chat_room" hx-get="/u/{{.User.Username}}/chat" hx-trigger="NEW_MESSAGE from:body" hx-select="#chat_room" hx-swap="outerHTML">
          {{range .Messages}}

          {{if (eq .SenderID $.Layout.User.ID)}}
          {{template "chat_message_mine" .}}
          {{else}}
          {{template "chat_message_other" .}}
          {{end}}

          {{end}}
        </div>
      </div>
    </div>

    {{template "chatInput" .}}
  </div>
</div>
{{end}}

{{define "chat_message_other"}}
<div class="f-row">
  <div class="speech-bubble left">
    {{.Body}}
  </div>
  <div class="flex-grow:1" style="min-width:100px;"></div>
</div>
{{end}}

{{define "chat_message_mine"}}
<div class="f-row">
  <div class="flex-grow:1" style="min-width:100px"></div>
  <div class="speech-bubble right">
    {{.Body}}
  </div>
</div>
{{end}}

{{define "chatInput"}}
<form id="form2" class="f-row" hx-post="/chat/messages" hx-swap="outerHTML"
      _="on submit add @disabled to #inp">
  <input id="inp" name="body" type="text" autofocus required class="flex-grow:1" placeholder="Type a message">
  <input name="roomID" value="{{.RoomID}}" type="hidden">
  <button>Send</button>
</form>
{{end}}

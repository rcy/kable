{{define "head"}}
  <title>{{.User.Username}}</title>

  <style>
    /* Hide scrollbar for Chrome, Safari and Opera */
   .hide-scrollbar::-webkit-scrollbar {
       display: none;
    }

    /* Hide scrollbar for IE, Edge and Firefox */
    .hide-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
  </style>
{{end}}

{{define "main"}}
  <script>
    const es = new EventSource("/es/room-{{.RoomID}}");

    // dispatch event for use by hx-trigger
    es.addEventListener("NEW_MESSAGE", (e) => {
      document.getElementsByTagName('body')[0].dispatchEvent(new Event("NEW_MESSAGE"))
    })
  </script>

  <div class="nes-container" style="height:100%; display:flex; flex-direction:column">
    <h1>chatting with {{.User.Username}}</h1>
    <div class="hide-scrollbar" style="flex:1; overflow-y: scroll; display:flex; flex-direction: column-reverse;">
      {{template "chatMessages" .}}
    </div>
    <div>
      {{template "chatInput" .}}
    </div>
  </div>
{{end}}

{{define "chatMessages"}}
  <div hx-get="/u/{{.User.ID}}/chat"
       hx-trigger="NEW_MESSAGE from:body"
       id="messages-{{.User.ID}}"
       hx-select="#messages-{{.User.ID}}"
       hx-swap="outerHTML">
    {{range .Messages}}
      {{if (eq .SenderID $.Layout.User.ID)}}
        {{template "chat_message_mine" .}}
      {{else}}
        {{template "chat_message_other" .}}
      {{end}}
    {{end}}
  </div>
{{end}}

{{define "chat_message_other"}}
  <div style="display:flex; align-items:end">
    <img style="margin-bottom: 8px" src="{{.SenderAvatarURL}}">
    <div class="nes-balloon from-left" style="overflow-wrap: break-word; max-width: 70%">
      {{.BodyHTML}}
    </div>
    <div style="flex:1"></div>
  </div>
{{end}}

{{define "chat_message_mine"}}
  <div style="display:flex; align-items:end">
    <div style="flex:1"></div>
    <div class="nes-balloon from-right" style="overflow-wrap: break-word; max-width: 70%">
      {{.BodyHTML}}
    </div>
    <img style="margin-bottom: 8px" src="{{.SenderAvatarURL}}">
  </div>
{{end}}

{{define "chatInput"}}
  <form id="form2"
        autocomplete="off"
        hx-post="/chat/messages" hx-swap="outerHTML"
        _="on submit add @disabled to #inp">
    <input name="roomID" value="{{.RoomID}}" type="hidden">

    <div style="display:flex">
      <input id="inp" name="body" type="text" autofocus required class="nes-input" placeholder="Type a message">
      <button class="nes-btn is-primary">Send</button>
    </div>
  </form>
{{end}}
